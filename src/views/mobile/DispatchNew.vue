<template>
  <div class="app-page">
    <header>
      <div class="page-title">
        <h3>
          <b-icon icon="calendar2-week"></b-icon>
          {{ $trans("Dispatch") }} &ndash; {{ $trans("week") }}<strong>{{ +this.startWeek }}</strong>
          {{ mode }}
        </h3>
        <div class="flex-columns">
          <b-button @click="function() { showSearchModal() }">
            <b-icon icon="search"></b-icon>
            {{ $trans('search') }}
          </b-button>

          <b-button @click="function() { loadToday() }">
            <b-icon icon="patch-exclamation-fill" v-if="newData" :title="$trans('dispatch changed, refresh now')"></b-icon>
            <b-icon icon="arrow-repeat" v-else></b-icon>
            {{ $trans('refresh') }}
          </b-button>

          <b-button-group>
            <b-button
              variant="primary"
              v-for="item in this.modeOptions"
              :key="item.name"
              :disabled="item.item === mode"
              @click="() => changeViewMode(item.item)">{{  item.name }}</b-button>
          </b-button-group>
        </div>
      </div>
    </header>

    <div class="panel">
      <div class="heading" v-if="assignMode && selectedOrders.length > 0">
        <b-row>
          <b-col cols="12">
            <strong>{{ $trans('Selected orders') }}:</strong>&nbsp;
            <span v-for="(order, index) in selectedOrders" :key="order.id">
              {{ order.order_id }}
              <b-link class="px-1" @click.prevent="removeSelectedOrder(index)">[ x ]</b-link>
            </span>
          </b-col>
        </b-row>
        <b-row>
          <b-col cols="6">
            <strong>{{ $trans('Selected users') }}:</strong>&nbsp;
            <span v-for="(user, index) in selectedUsers" :key="user.user_id">
              {{ user.full_name }} {{ user.user_id }}
              <b-link class="px-1" @click.prevent="removeSelectedUser(index)">[ x ]</b-link>
            </span>
          </b-col>
          <b-col cols="6">
            <strong>{{ $trans('Already assigned users') }}:</strong>&nbsp;
            <span v-for="user in alreadyAssignedUsers" :key="user.user_id">
              {{ user.full_name }} {{ user.user_id }}
            </span>
          </b-col>
        </b-row>
        <b-row>
          <b-col cols="12">
            <footer class="modal-footer">
              <b-button @click="cancelAssign" :disabled="buttonDisabled" class="btn btn-secondary" type="button" variant="secondary">
                {{ $trans('Cancel') }}</b-button>
              <b-button @click="assignToUsers" :disabled="buttonDisabled" class="btn btn-primary" type="button" variant="primary">
                {{ $trans('Submit') }}</b-button>
            </footer>
          </b-col>
        </b-row>
      </div>

      <div class="flex-columns" style="justify-content: space-between;">

        <b-link class="px-1" @click.prevent="timeBackWeek" v-bind:title="$trans('Week back')">
          <b-icon icon="arrow-left-square-fill" font-scale="1.2"></b-icon> week {{ this.startWeek - 1 }}
        </b-link>

        <span class="flex-columns">
          <b-link class="px-1" @click.prevent="timeBack" v-bind:title="$trans('Day back') ">
            <b-icon-arrow-left-short font-scale="1.8"></b-icon-arrow-left-short>
          </b-link>
          <b-form-datepicker
            v-model="startDate"
            size="sm"
            placeholder="Start date"
            locale="nl"
            :date-format-options="{ day: '2-digit', month: '2-digit', year: 'numeric' }"
          ></b-form-datepicker>
          <b-button @click="function() { loadToday() }" variant="primary" size="sm" style="color: white; white-space: nowrap;">
            <b-icon icon="calendar2-date-fill"></b-icon>&nbsp;
            {{ $trans('today') }}
          </b-button>
          <b-link class="px-1" @click.prevent="timeForward" :title="$trans('Day forward')">
            <b-icon-arrow-right-short font-scale="1.8"></b-icon-arrow-right-short>
          </b-link>
        </span>

        <b-link class="" @click.prevent="timeForwardWeek" v-bind:title="$trans('Week forward') ">
          week {{ (+this.startWeek + 1) }}
          <b-icon icon="arrow-right-square-fill" font-scale="1.2"></b-icon>
        </b-link>

      </div>
      <hr/>

      <DispatchWeek
        v-if="loadDone"
        :startDate.sync="startDate"
        :orderClickHandler="openActionsModal"
        :mode="this.mode"
        :is-assign-mode="assignMode"
        :already-assigned-users="alreadyAssignedUsers"
        @addSelectedUser="addSelectedUser"
      />

    </div>

    <SearchModal
      id="search-modal"
      ref="search-modal"
      @do-search="handleSearchOk"
    />

    <b-modal
      ref="dispatch-change-date-modal"
      id="dispatch-change-date-modal"
      v-bind:title="$trans('Change date')"
      @ok="changeDateOk"
      v-if="assignedOrder !== null"
    >
      <form ref="change-date-form" @submit.stop.prevent="changeDateSubmit">
        <b-container fluid>
          <b-row role="group">
            <b-col size="6">
              <b-form-group
                v-bind:label="$trans('Start date')"
                label-for="alt-start-date"
              >
                <b-form-datepicker
                  id="alt-start-date"
                  size="sm"
                  class="p-sm-0"
                  v-model="assignedOrder.alt_start_date"
                  v-bind:placeholder="$trans('Choose a date')"
                  locale="nl"
                  :date-format-options="{ year: 'numeric', month: '2-digit', day: '2-digit' }"
                  :min="minDate"
                  :max="maxDate"
                  value-as-date
                ></b-form-datepicker>
              </b-form-group>
            </b-col>
            <b-col size="6">
              <b-form-group
                v-bind:label="$trans('Start time')"
                label-for="alt-start-time"
              >
                <b-form-timepicker
                  id="alt-start-time"
                  size="sm"
                  v-model="assignedOrder.alt_start_time"
                  class="mb-2"
                  v-bind:placeholder="$trans('Choose a time')"
                  :hour12=false
                ></b-form-timepicker>
              </b-form-group>
            </b-col>
          </b-row>
          <b-row>
            <b-col size="6">
              <b-form-group
                v-bind:label="$trans('End date')"
                label-for="alt-end-date"
              >
                <b-form-datepicker
                  id="alt-end-date"
                  size="sm"
                  class="p-sm-0"
                  v-model="assignedOrder.alt_end_date"
                  v-bind:placeholder="$trans('Choose a date')"
                  locale="nl"
                  :date-format-options="{ year: 'numeric', month: '2-digit', day: '2-digit' }"
                  :min="minDate"
                  :max="maxDate"
                  value-as-date
                ></b-form-datepicker>
              </b-form-group>
            </b-col>
            <b-col size="6">
              <b-form-group
                v-bind:label="$trans('End time')"
                label-for="alt-end-time"
              >
                <b-form-timepicker
                  id="alt-end-time"
                  size="sm"
                  v-model="assignedOrder.alt_end_time"
                  class="mb-2"
                  v-bind:placeholder="$trans('Choose a time')"
                  :hour12=false
                ></b-form-timepicker>
              </b-form-group>
            </b-col>
          </b-row>
          <b-row>
            <b-col size="6"></b-col>
            <b-col size="6" class="text-right">
              <b-link class="px-1" title="clear" v-on:click.native="clearAssignedorderDates()">
                {{ $trans('clear') }}
              </b-link>
            </b-col>
          </b-row>
        </b-container>
      </form>
    </b-modal>

    <b-modal
      id="dispatch-order-actions-modal"
      ref="dispatch-order-actions-modal"
      v-bind:title="`${$trans('Order')} ${selectedOrder && selectedOrder.order_id || '' }`"
    >
      <template #default="">
        {{ $trans('Order') }} {{ selectedOrder.order_id }}<br/>
        {{ selectedOrder.order_name }}<br/>
        {{ selectedOrder.order_address }}<br/>
        {{ selectedOrder.order_postal }} {{ selectedOrder.order_city }}<br/>
        {{ $trans('Order date') }}: {{ selectedOrder.order_date }}<br/>
        <span v-if="assignedOrder && assignedOrder.assignedorder_date != ''">
            {{ $trans('User date') }}: {{ assignedOrder.assignedorder_date }}<br/>
        </span>
        <span v-if="selectedOrder.order_reference != ''">
            {{ $trans('Reference') }}: {{ selectedOrder.order_reference }}<br/>
        </span>
      </template>
      <template #modal-footer="{ cancel }">
        <b-row>
          <b-col cols="1" class="mx-1">
            <b-button size="sm" variant="info" @click="viewOrder">{{ $trans('Info') }}</b-button>
          </b-col>
          <b-col cols="1" class="mx-1">
            <b-button size="sm" variant="primary" @click="editOrder">{{ $trans('Edit') }}</b-button>
          </b-col>
          <b-col cols="4" class="mx-1" v-if="assignedOrder">
            <b-button size="sm" variant="primary" @click="changeDate">{{ $trans('Change date') }}</b-button>
          </b-col>
          <b-col cols="4" class="mx-1" v-if="!assignedOrder">&nbsp;</b-col>
          <b-col cols="2" class="mx-1">
            <b-button size="sm" variant="danger" @click="postUnassign">{{ $trans('Remove') }}</b-button>
          </b-col>
          <b-col cols="2" class="mx-1">
            <b-button size="sm" @click="cancel()">{{ $trans('Close') }}</b-button>
          </b-col>
        </b-row>

      </template>
    </b-modal>
  </div>
</template>

<script>
import moment from 'moment/min/moment-with-locales'

import DispatchWeek from './dispatch/DispatchWeek.vue'
import {OrderService} from '@/models/orders/Order'
import {AssignedOrderService} from '@/models/mobile/AssignedOrder'
import { AssignService } from '@/models/mobile/Assign'
import SearchModal from '../../components/SearchModal.vue'
import MemberNewDataSocket from '../../services/websocket/MemberNewDataSocket.js'
import {NEW_DATA_EVENTS} from '@/constants';

const memberNewDataSocket = new MemberNewDataSocket()

class SelectedUser {
  user_id
  full_name
}

export default {
  name: 'DispatchNew',
  components: {
    SearchModal,
    DispatchWeek
  },
  props: {
    assignModeProp: {
      type: [Boolean],
      default: false
    },
  },
  data() {
    return {
      mode: null,
      modeOptions: [
        { item: 'compact', name: this.$trans('Compact') },
        { item: 'wide', name: this.$trans('Wide') },
      ],
      scrollTopButton: null,
      searchQuery: null,
      buttonDisabled: false,
      assignMode: false,
      selectedOrders: [],
      selectedOrderIds: [],
      selectedUsers: [],
      alreadyAssignedUsers: [],
      selectedOrder: null,
      selectedOrderUserId: null,
      assignedOrder: null,
      assignedOrderPk: null,
      dispatch: null,
      showOverlay: false,
      // startDate: moment(new Date()).weekday(1),
      startDate: moment("2023-12-18"),
      // mode: 'week'
      startWeek: this.startWeek = moment("2023-12-18").format('w'),
      newData: false,
      minDate: null,
      maxDate: null,
      statuscodes: null,
      loadDone: false,
      assignedOrderService: new AssignedOrderService(),
      orderService: new OrderService(),
      assignService: new AssignService()
    }
  },
  computed: {
    isAssignMode: function() {
      console.log(this.assignMode, this.selectedOrders.length)
      return this.assignMode && this.selectedOrders.length > 0
    }
  },
  watch: {
    mode: function(val) {
      localStorage.setItem('displayMode', JSON.stringify(val))
    },
    startDate: function(val) {
      this.startWeek = moment(val).format('w');
    }
  },
  methods: {
    // change view mode
    changeViewMode(mode) {
      this.mode = mode;
    },
    // dates
    clearAssignedorderDates() {
      this.assignedOrder.alt_start_date = null
      this.assignedOrder.alt_end_date = null
      this.assignedOrder.alt_start_time = null
      this.assignedOrder.alt_end_time = null
    },
    changeDate() {
      this.$refs['dispatch-order-actions-modal'].hide()
      this.$refs['dispatch-change-date-modal'].show()
    },
    changeDateOk(bvModalEvt) {
      bvModalEvt.preventDefault()
      this.changeDateSubmit()
    },
    async changeDateSubmit() {
      this.showOverlay = true

      try {
        await this.assignedOrderService.updateDetailChangeDate(this.assignedOrderPk, this.assignedOrder)
        this.$refs['dispatch-change-date-modal'].hide();
        this.showOverlay = false
        // this.dispatch.drawDispatch()
      } catch(error) {
        console.log('error updating assignedOrder dates', error)
        this.errorToast(this.$trans('Error updating dates'))
        this.showOverlay = false
      }
    },
    // search
    handleSearchOk(val) {
      this.$refs['search-modal'].hide()
      setTimeout(() => {
        // this.dispatch.setSearchQuery(val)
        // this.dispatch.search()
      }, 500)
      this.loadData()
    },
    showSearchModal() {
      this.$refs['search-modal'].show()
    },
    // rest
    loadToday() {
      // this.dispatch.loadToday()
      this.startDate = new Date();
    },
    viewOrder() {
      this.$refs['dispatch-order-actions-modal'].hide();
      this.$root.$once('bv::modal::hidden', (bvEvent, modalId) => {
        this.$router.push({name: 'order-view', params: {pk: this.selectedOrder.id}})
      })
    },
    editOrder() {
      this.$refs['dispatch-order-actions-modal'].hide();
      this.$root.$once('bv::modal::hidden', (bvEvent, modalId) => {
        this.$router.push({name: 'order-edit', params: {pk: this.selectedOrder.id}})
      })
    },
    async openActionsModal(order_pk, assignedorder_pk) {
      console.log({order_pk, assignedorder_pk});
      this.assignedOrderPk = assignedorder_pk

      try {
        this.showOverlay = true
        this.selectedOrder = await this.orderService.detail(order_pk)

        if (assignedorder_pk) {
          this.assignedOrder = await this.assignedOrderService.getDetailChangeDate(assignedorder_pk)

          this.assignedOrder.alt_start_date = this.$moment(this.assignedOrder.alt_start_date, 'DD/MM/YYYY').toDate()
          this.assignedOrder.alt_end_date = this.$moment(this.assignedOrder.alt_end_date, 'DD/MM/YYYY').toDate()

          this.minDate = this.assignedOrder.order_start_date
          this.maxDate = this.assignedOrder.order_end_date
        } else {
          this.assignedOrder = null
        }
        this.showOverlay = false
        this.$refs['dispatch-order-actions-modal'].show();
      } catch (error) {
        console.log('error fetching order', error)
        this.errorToast(this.$trans('Error fetching order'))
      }
    },
    addSelectedUser(user) {
      if (this.userAlreadyAssigned(user.user_id)) {
        this.infoToast(this.$trans('Already assigned'), this.$trans('Order(s) already assigned'))
        return
      }
      if (!this.userAlreadySelected(user.user_id)) {
        this.selectedUsers.push(user)
      }
    },
    userAlreadySelected(user_id) {
      return this.selectedUsers.find(user => user.user_id === user_id)
    },
    userAlreadyAssigned(user_id) {
      return this.alreadyAssignedUsers.find(user => user.user_id === user_id)
    },
    async assignToUsers() {
      this.showOverlay = true
      this.buttonDisabled = true
      let user_ids = this.selectedUsers.map(o => o.user_id)

      if (this.selectedOrderIds.length === 0) {
        this.selectedOrderIds = this.selectedOrders.map(o => o.order_id)
      }

      try {
        for (const user_id of user_ids) {
          await this.assignService.assignToUser(user_id, this.selectedOrderIds, true)
        }

        this.infoToast(this.$trans('Success'), this.$trans('Order(s) assigned'))
        this.cancelAssign()
        this.buttonDisabled = false
        this.showOverlay = false
      } catch (e) {
        this.errorToast(this.$trans('Error assigning order(s)'))
        this.showOverlay = false
        this.buttonDisabled = false
      }
    },
    postUnassign() {
      this.showOverlay = true

      this.$refs['dispatch-order-actions-modal'].hide();
      this.$root.$once('bv::modal::hidden', async (bvEvent, modalId) => {
        try {
          await this.assignService.unAssign(this.selectedOrderUserId, this.selectedOrder.id)
          this.infoToast(this.$trans('Success'), this.$trans('Order removed from planning'))
          this.showOverlay = false
        } catch (error) {
          console.log('error un-assigning', error)
          this.errorToast(this.$trans('Error un-assigning order'))
          this.showOverlay = false
        }
      })
    },
    cancelAssign() {
      this.selectedUsers = [];
      this.selectedOrders = [];
      this.assignMode = false;
      this.$store.dispatch('setAssignOrders', this.selectedOrders)
    },
    removeSelectedOrder(index) {
      this.selectedOrders.splice(index, 1);
    },
    removeSelectedUser(index) {
      this.selectedUsers.splice(index, 1);
    },
    timeForwardWeek() {
      this.startDate = moment(this.startDate).add(1, 'w').toDate()
    },
    timeForward() {
      this.startDate = moment(this.startDate).add(1, 'd').toDate()
    },
    timeBackWeek() {
      this.startDate = moment(this.startDate).subtract(1, 'w').toDate()
    },
    timeBack() {
      this.startDate = moment(this.startDate).subtract(1, 'd').toDate()
    },
    onNewData(data) {
      if (data.type === NEW_DATA_EVENTS.DISPATCH) {
        this.newData = true
      }
    }
  },
  async mounted() {
    await memberNewDataSocket.init(NEW_DATA_EVENTS.DISPATCH)
    memberNewDataSocket.setOnmessageHandler(this.onNewData)
    memberNewDataSocket.getSocket()

    const displayMode = JSON.parse(localStorage.getItem('displayMode'))
    const mode = displayMode ? displayMode : 'wide'

    const lang = this.$store.getters.getCurrentLanguage
    const monday = lang === 'en' ? 1 : 0
    this.$moment = moment
    this.$moment.locale(lang)

    this.assignMode = this.assignModeProp

    if (this.assignMode) {
      this.alreadyAssignedUsers = []
      this.selectedOrders = await this.$store.dispatch('getAssignOrders')
      for (const order of this.selectedOrders) {
        this.alreadyAssignedUsers.push(...order.assigned_user_info.map((userInfo) => {
          return {
            user_id: userInfo.user_id,
            full_name: userInfo.full_name
          }
        }))
      }
      console.log(this.alreadyAssignedUsers)
    }

    this.statuscodes = await this.$store.dispatch('getStatuscodes')

    this.mode = mode
    this.loadDone = true
  },
  beforeDestroy() {
    memberNewDataSocket.removeOnmessageHandler(NEW_DATA_EVENTS.DISPATCH)
  }
}
</script>

<style scoped>
.heading {
  position: sticky;
  top: 0;
  background: #fff;
  opacity: .9;
  z-index: 1000;
}
.flex-columns a {
  align-self: center;
}

</style>
